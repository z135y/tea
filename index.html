<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCA x TAGs V3 (Param Lab)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --c-a: #e74c3c; --c-b: #3498db; --c-c: #27ae60; --bg: #f4f6f7; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); color: #2c3e50; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: #fff; width: 100%; max-width: 1400px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap; overflow: hidden; }
        
        /* --- å·¦å´æ§åˆ¶å€ --- */
        .controls { flex: 1.2; min-width: 450px; padding: 30px; border-right: 1px solid #eee; height: 90vh; overflow-y: auto; background: #fff; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #6f4e37; padding-bottom: 15px; margin-bottom: 20px; }
        h2 { margin: 0; color: #6f4e37; font-weight: 900; }
        
        .section-title { font-size: 14px; color: #555; margin: 20px 0 10px 0; border-left: 4px solid #6f4e37; padding-left: 10px; font-weight: bold; background: #f9f9f9; padding: 5px 10px; border-radius: 0 5px 5px 0; }

        /* --- å…¨åŸŸè³‡è¨Š --- */
        .global-meta { display: flex; gap: 10px; margin-bottom: 20px; }
        .global-meta input, .global-meta select { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* --- æ ¸å¿ƒï¼šç¨ç«‹æ¨£æœ¬åƒæ•¸å¡ç‰‡ --- */
        .sample-deck { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .sample-card { padding: 15px; border-radius: 8px; background: #fafafa; border-top: 5px solid #ccc; display: flex; flex-direction: column; gap: 8px; }
        
        /* A/B/C å°ˆå±¬æ¨£å¼ */
        .card-a { border-color: var(--c-a); background: rgba(231, 76, 60, 0.03); }
        .card-b { border-color: var(--c-b); background: rgba(52, 152, 219, 0.03); }
        .card-c { border-color: var(--c-c); background: rgba(39, 174, 96, 0.03); }

        .sample-card label { font-size: 11px; font-weight: bold; color: #888; margin-bottom: -5px; }
        .sample-card input { width: 100%; padding: 6px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-weight: bold; }
        .sample-card input:focus { border-color: #666; outline: none; }
        
        /* è¼¸å…¥æ¡†é¡è‰²å¼·èª¿ */
        .card-a input { color: var(--c-a); border-left: 3px solid var(--c-a); }
        .card-b input { color: var(--c-b); border-left: 3px solid var(--c-b); }
        .card-c input { color: var(--c-c); border-left: 3px solid var(--c-c); }

        /* --- è©•åˆ†å€ --- */
        .score-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .score-label { font-size: 13px; font-weight: bold; }
        .term-sub { font-size: 11px; color: #999; display: block; }
        
        .range-wrap { text-align: center; }
        .range-wrap input { width: 100%; height: 4px; cursor: pointer; margin: 5px 0; }
        .range-val { font-size: 14px; font-weight: bold; }
        
        .sample-a input[type=range] { accent-color: var(--c-a); } .color-a { color: var(--c-a); }
        .sample-b input[type=range] { accent-color: var(--c-b); } .color-b { color: var(--c-b); }
        .sample-c input[type=range] { accent-color: var(--c-c); } .color-c { color: var(--c-c); }

        /* --- å³å´é è¦½ --- */
        .preview { flex: 1.5; background: #fff; padding: 30px; display: flex; flex-direction: column; align-items: center; }
        .chart-container { width: 100%; max-width: 650px; margin-bottom: 20px; }
        .btn-submit { background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white; border: none; padding: 15px 50px; font-size: 16px; border-radius: 50px; cursor: pointer; font-weight: bold; width: 80%; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
        .btn-submit:disabled { background: #ccc; }

        @media (max-width: 900px) { 
            .container { flex-direction: column; } 
            .controls { height: auto; border-right: none; }
            .sample-deck { grid-template-columns: 1fr; } /* æ‰‹æ©Ÿç‰ˆè®Šæˆå‚ç›´æ’åˆ— */
            .score-grid { grid-template-columns: 1fr; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <div class="header">
            <h2>SCA x TAGs Lab</h2>
            <div style="font-size:12px; color:#999;">V3.0 Independent Params</div>
        </div>

        <div class="section-title">ğŸ‘¤ åŸºæœ¬è³‡è¨Š</div>
        <div class="global-meta">
            <select id="teaCategory">
                <option value="Black">ç´…èŒ¶ (Black)</option>
                <option value="Oolong">çƒé¾ (Oolong)</option>
                <option value="Green">ç¶ èŒ¶ (Green)</option>
                <option value="Blend">æ··èª¿ (Blend)</option>
            </select>
            <input type="text" id="cupperName" placeholder="Cupper Name">
            <input type="email" id="cupperEmail" placeholder="Email for Report">
        </div>

        <div class="section-title">ğŸ§ª æ¨£æœ¬åƒæ•¸è¨­å®š (ç¨ç«‹æ§åˆ¶)</div>
        <div class="sample-deck">
            <div class="sample-card card-a">
                <label>SAMPLE A (åç¨±)</label>
                <input type="text" id="nameA" value="æ¨™æº–æ²–æ³¡" oninput="updateChart()">
                <label>Temp (Â°C) / Time</label>
                <input type="text" id="paramA1" value="95Â°C / 5min" placeholder="95Â°C / 5min">
                <label>Ratio (g:ml)</label>
                <input type="text" id="paramA2" value="3g : 150ml">
            </div>
            <div class="sample-card card-b">
                <label>SAMPLE B (åç¨±)</label>
                <input type="text" id="nameB" value="é™æº«æ¸¬è©¦" oninput="updateChart()">
                <label>Temp (Â°C) / Time</label>
                <input type="text" id="paramB1" value="85Â°C / 6min" placeholder="85Â°C / 6min">
                <label>Ratio (g:ml)</label>
                <input type="text" id="paramB2" value="3g : 150ml">
            </div>
            <div class="sample-card card-c">
                <label>SAMPLE C (åç¨±)</label>
                <input type="text" id="nameC" value="æ¿ƒç¸®æ¸¬è©¦" oninput="updateChart()">
                <label>Temp (Â°C) / Time</label>
                <input type="text" id="paramC1" value="95Â°C / 3min" placeholder="95Â°C / 3min">
                <label>Ratio (g:ml)</label>
                <input type="text" id="paramC2" value="5g : 150ml">
            </div>
        </div>

        <div class="section-title">ğŸ“Š å®˜èƒ½è©•é‘‘</div>
        <div id="scoreArea"></div>

        <div class="section-title">ğŸ“ ç¶œåˆç­†è¨˜</div>
        <textarea id="notes" rows="3" style="width:100%; border-color:#ddd; padding:10px;" placeholder="å¯¦é©—çµè«–ï¼šAçµ„é¦™æ°£è¼ƒä½³ä½†ç•¥æ¾€ï¼ŒBçµ„ç”œæ„Ÿçªå‡º..."></textarea>
    </div>

    <div class="preview">
        <div class="chart-container"><canvas id="radarChart"></canvas></div>
        <button class="btn-submit" id="submitBtn" onclick="processData()">ğŸš€ ç”Ÿæˆå¯¦é©—å ±å‘Š</button>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwe4QryJQ0Gcf6guVEXs1a3Z_tM3la_oq-queI09S0Qd8zql3o6L87XF3-sh705AHNymg/exec"; 

    const attributes = [
        { en: "Acidity", ch: "æ˜äº®é®®çˆ½", key: "p1" },
        { en: "Sweetness", ch: "å›ç”˜èœœéŸ»", key: "p2" },
        { en: "Body", ch: "èŒ¶æ¹¯ç¨ åº¦", key: "p3" },
        { en: "Aroma", ch: "å±¤æ¬¡èª¿æ€§", key: "p4" },
        { en: "Balance", ch: "å”èª¿æ€§", key: "p5" },
        { en: "Structure", ch: "æ”¶æ–‚è½‰åŒ–", key: "p6" }
    ];

    let myChart;

    window.onload = function() {
        generateScoreInputs();
        initChart();
    };

    function generateScoreInputs() {
        const area = document.getElementById('scoreArea');
        let html = '';
        attributes.forEach((attr, idx) => {
            html += `
            <div class="score-grid">
                <div class="score-label">${attr.en}<span class="term-sub">${attr.ch}</span></div>
                <div class="range-wrap sample-a">
                    <span class="range-val color-a" id="vA${idx}">4.0</span>
                    <input type="range" id="A_p${idx}" min="0" max="5" step="0.1" value="4.0" oninput="updateVal('A', ${idx})">
                </div>
                <div class="range-wrap sample-b">
                    <span class="range-val color-b" id="vB${idx}">3.0</span>
                    <input type="range" id="B_p${idx}" min="0" max="5" step="0.1" value="3.0" oninput="updateVal('B', ${idx})">
                </div>
                <div class="range-wrap sample-c">
                    <span class="range-val color-c" id="vC${idx}">2.0</span>
                    <input type="range" id="C_p${idx}" min="0" max="5" step="0.1" value="2.0" oninput="updateVal('C', ${idx})">
                </div>
            </div>`;
        });
        area.innerHTML = html;
    }

    function updateVal(sample, idx) {
        document.getElementById(`v${sample}${idx}`).innerText = document.getElementById(`${sample}_p${idx}`).value;
        updateChart();
    }

    function initChart() {
        const ctx = document.getElementById('radarChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: attributes.map(a => [a.en, a.ch]),
                datasets: [
                    { label: 'A', data: [4,4,4,4,4,4], borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', borderWidth: 2 },
                    { label: 'B', data: [3,3,3,3,3,3], borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', borderWidth: 2 },
                    { label: 'C', data: [2,2,2,2,2,2], borderColor: '#27ae60', backgroundColor: 'rgba(39, 174, 96, 0.1)', borderWidth: 2 }
                ]
            },
            options: {
                responsive: true,
                scales: { r: { suggestedMin: 0, suggestedMax: 5, pointLabels: { font: { size: 12, weight:'bold'} } } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function updateChart() {
        const dataA = attributes.map((_, i) => document.getElementById(`A_p${i}`).value);
        const dataB = attributes.map((_, i) => document.getElementById(`B_p${i}`).value);
        const dataC = attributes.map((_, i) => document.getElementById(`C_p${i}`).value);
        
        myChart.data.datasets[0].label = document.getElementById('nameA').value || 'A';
        myChart.data.datasets[1].label = document.getElementById('nameB').value || 'B';
        myChart.data.datasets[2].label = document.getElementById('nameC').value || 'C';
        
        myChart.data.datasets[0].data = dataA;
        myChart.data.datasets[1].data = dataB;
        myChart.data.datasets[2].data = dataC;
        myChart.update();
    }

    function generateLayoutImage(callback) {
        const canvas = document.getElementById('radarChart');
        const tempCanvas = document.createElement('canvas');
        const ctx = tempCanvas.getContext('2d');
        
        // ç‰ˆé¢è¨­å®š
        const scale = 2;
        const extraH = 450; // å¢åŠ é«˜åº¦ä»¥å®¹ç´è©³ç´°åƒæ•¸è¡¨
        tempCanvas.width = canvas.width * scale;
        tempCanvas.height = (canvas.height * scale) + extraH;
        
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,tempCanvas.width, tempCanvas.height);
        
        // ç¹ªåœ–
        ctx.save(); ctx.scale(scale, scale); ctx.drawImage(canvas, 0, 0); ctx.restore();

        let y = (canvas.height * scale) + 20;
        const cw = tempCanvas.width;
        
        // æ¨™é¡Œ
        ctx.font = "bold 32px Microsoft JhengHei"; ctx.textAlign = "center"; ctx.fillStyle = "#333";
        ctx.fillText(`SCA x TAGs æ„Ÿå®˜å¯¦é©—å®¤`, cw/2, 50);

        // è¡¨æ ¼è¨­å®š
        const colW = cw / 4;
        const startY = y;
        const rowH = 40;
        
        // å®šç¾©è¡¨æ ¼å…§å®¹ (å«åƒæ•¸)
        const headers = ["é …ç›® Item", 
            document.getElementById('nameA').value, 
            document.getElementById('nameB').value, 
            document.getElementById('nameC').value
        ];

        const params1 = ["Temp/Time", 
            document.getElementById('paramA1').value, 
            document.getElementById('paramB1').value, 
            document.getElementById('paramC1').value
        ];

        const params2 = ["Ratio", 
            document.getElementById('paramA2').value, 
            document.getElementById('paramB2').value, 
            document.getElementById('paramC2').value
        ];

        // ç¹ªè£½è¡¨é ­ (èƒŒæ™¯è‰²)
        ctx.fillStyle = "#f2f2f2"; ctx.fillRect(40, y, cw-80, rowH*3); // åƒæ•¸å€èƒŒæ™¯
        
        // ç¹ªè£½åƒæ•¸æ–‡å­—
        const drawRow = (data, color, isBold, offsetY) => {
            data.forEach((txt, i) => {
                ctx.fillStyle = (i===0) ? "#555" : color[i-1];
                ctx.font = isBold ? "bold 22px Microsoft JhengHei" : "20px Microsoft JhengHei";
                ctx.fillText(txt, 40 + colW*i + colW/2, offsetY);
            });
        };

        const colors = ["#e74c3c", "#3498db", "#27ae60"];

        // åƒæ•¸å€å…§å®¹
        drawRow(headers, colors, true, y + 28);
        drawRow(params1, colors, false, y + 28 + rowH);
        drawRow(params2, colors, false, y + 28 + rowH*2);
        
        y += rowH*3 + 20; // å¾€ä¸‹ç§»å‹•ç•«åˆ†æ•¸

        // åˆ†æ•¸å€
        attributes.forEach((attr, idx) => {
            const valA = document.getElementById(`A_p${idx}`).value;
            const valB = document.getElementById(`B_p${idx}`).value;
            const valC = document.getElementById(`C_p${idx}`).value;
            
            ctx.fillStyle = "#333"; ctx.font = "bold 20px Microsoft JhengHei";
            ctx.fillText(attr.en, 40 + colW/2, y);
            
            ctx.fillStyle = colors[0]; ctx.fillText(valA, 40 + colW*1.5, y);
            ctx.fillStyle = colors[1]; ctx.fillText(valB, 40 + colW*2.5, y);
            ctx.fillStyle = colors[2]; ctx.fillText(valC, 40 + colW*3.5, y);
            
            ctx.strokeStyle="#eee"; ctx.beginPath(); ctx.moveTo(40, y+10); ctx.lineTo(cw-40, y+10); ctx.stroke();
            y += 40;
        });

        callback(tempCanvas.toDataURL('image/jpeg', 0.7));
    }

    function processData() {
        const btn = document.getElementById('submitBtn');
        const email = document.getElementById('cupperEmail').value;
        if(!email.includes("@")) { alert("è«‹å¡«å¯« Email"); return; }
        
        btn.disabled = true; btn.innerText = "â³ è™•ç†ä¸­...";

        generateLayoutImage((base64) => {
            const payload = {
                cupper: document.getElementById('cupperName').value,
                email: email,
                category: document.getElementById('teaCategory').value,
                // Açµ„å®Œæ•´è³‡æ–™
                teaA: document.getElementById('nameA').value,
                paramA1: document.getElementById('paramA1').value, // æº«/æ™‚
                paramA2: document.getElementById('paramA2').value, // æ¯”ä¾‹
                scoresA: attributes.map((_, i) => document.getElementById(`A_p${i}`).value),
                // Bçµ„å®Œæ•´è³‡æ–™
                teaB: document.getElementById('nameB').value,
                paramB1: document.getElementById('paramB1').value,
                paramB2: document.getElementById('paramB2').value,
                scoresB: attributes.map((_, i) => document.getElementById(`B_p${i}`).value),
                // Cçµ„å®Œæ•´è³‡æ–™
                teaC: document.getElementById('nameC').value,
                paramC1: document.getElementById('paramC1').value,
                paramC2: document.getElementById('paramC2').value,
                scoresC: attributes.map((_, i) => document.getElementById(`C_p${i}`).value),
                
                note: document.getElementById('notes').value,
                image: base64
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("âœ… å¯¦é©—æ•¸æ“šå·²ä¸Šå‚³ï¼");
                btn.disabled = false; btn.innerText = "ğŸš€ ç”Ÿæˆå¯¦é©—å ±å‘Š";
            }).catch(e => {
                alert("âŒ éŒ¯èª¤ï¼š" + e);
                btn.disabled = false;
            });
        });
    }
</script>

</body>
</html>
