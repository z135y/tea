<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCA x TAGs Pro è©•é‘‘ (3-Sample Compare)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- æ ¸å¿ƒæ¶æ§‹ --- */
        :root { --c-a: #e74c3c; --c-b: #3498db; --c-c: #27ae60; --bg: #f4f6f7; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); color: #2c3e50; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: #fff; width: 100%; max-width: 1400px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap; overflow: hidden; }
        
        /* --- å·¦å´æ§åˆ¶å€ --- */
        .controls { flex: 1.2; min-width: 400px; padding: 30px; border-right: 1px solid #eee; height: 90vh; overflow-y: auto; background: #fff; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #6f4e37; padding-bottom: 15px; margin-bottom: 20px; }
        h2 { margin: 0; color: #6f4e37; font-weight: 900; }
        
        /* --- å€å¡Šæ¨™é¡Œ --- */
        .section-title { font-size: 15px; color: #555; margin: 25px 0 15px 0; border-left: 4px solid #6f4e37; padding-left: 10px; font-weight: bold; background: #f9f9f9; padding: 8px 10px; border-radius: 0 5px 5px 0; }

        /* --- å…¨åŸŸè¨­å®š (é©ç”¨æ‰€æœ‰æ¨£å“) --- */
        .global-settings { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        .input-group label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #7f8c8d; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 6px; font-size: 14px; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: #6f4e37; outline: none; }

        /* --- è©•åˆ†æ ¸å¿ƒå€ (Grid Layout) --- */
        .score-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .score-label { font-size: 14px; font-weight: bold; color: #2c3e50; }
        .term-sub { font-size: 12px; color: #7f8c8d; display: block; font-weight: normal; }
        
        /* æ»‘æ¡¿è¨­è¨ˆ */
        .range-wrap { text-align: center; position: relative; }
        .range-wrap input { width: 100%; cursor: pointer; height: 5px; margin: 10px 0; }
        .range-val { font-size: 14px; font-weight: bold; display: block; }
        
        /* A/B/C å°ˆå±¬è‰²ç³» */
        .sample-a input[type=range] { accent-color: var(--c-a); } .color-a { color: var(--c-a); }
        .sample-b input[type=range] { accent-color: var(--c-b); } .color-b { color: var(--c-b); }
        .sample-c input[type=range] { accent-color: var(--c-c); } .color-c { color: var(--c-c); }

        /* --- æ¨£å“åç¨±è¼¸å…¥åˆ— --- */
        .sample-names { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; align-items: end; }
        .sample-col input { text-align: center; font-weight: bold; border-width: 2px; }
        .sample-col:nth-child(2) input { border-color: var(--c-a); color: var(--c-a); }
        .sample-col:nth-child(3) input { border-color: var(--c-b); color: var(--c-b); }
        .sample-col:nth-child(4) input { border-color: var(--c-c); color: var(--c-c); }

        /* --- å³å´é è¦½å€ --- */
        .preview { flex: 1.5; background: #fdfdfd; padding: 30px; display: flex; flex-direction: column; align-items: center; position: relative; }
        .chart-container { width: 100%; max-width: 650px; position: relative; margin-bottom: 20px; }
        
        .btn-submit { background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white; border: none; padding: 15px 50px; font-size: 16px; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.3s; width: 80%; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
        .btn-submit:disabled { background: #bdc3c7; cursor: wait; }

        /* RWD */
        @media (max-width: 900px) { .container { flex-direction: column; } .controls { height: auto; border-right: none; } .score-grid { grid-template-columns: 1fr; border: 1px solid #eee; padding: 15px; border-radius: 8px; } .sample-names { display: none; } /* Mobile hide top names, rely on inline colors */ }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <div class="header">
            <h2>SCA x TAGs Pro</h2>
            <div style="font-size:12px; color:#999;">Ver 2.0 Multi-Sample</div>
        </div>

        <div class="section-title">âš™ï¸ åƒæ•¸è¨­å®š (Unified Database)</div>
        <div class="global-settings">
            <div class="input-group">
                <label>èŒ¶ç¨®åˆ†é¡ (Category)</label>
                <select id="teaCategory" onchange="autoFillStyle()">
                    <option value="Black">ç´…èŒ¶ (Black Tea)</option>
                    <option value="Oolong">çƒé¾èŒ¶ (Oolong Tea)</option>
                    <option value="Green">ç¶ èŒ¶ (Green Tea)</option>
                    <option value="White">ç™½èŒ¶ (White Tea)</option>
                    <option value="Herbal">èŠ±è‰/æ··èª¿ (Blend)</option>
                </select>
            </div>
            <div class="input-group"><label>è©•é‘‘è€… (Cupper)</label><input type="text" id="cupperName" placeholder="æ‚¨çš„å§“å"></div>
            <div class="input-group"><label>ç²‰æ°´æ¯” (Ratio)</label><input type="text" id="brewRatio" value="1:50" placeholder="ä¾‹ 1:50"></div>
            <div class="input-group"><label>æµ¸æ³¡æ™‚é–“ (Time)</label><input type="text" id="brewTime" value="5 min" placeholder="ä¾‹ 5 min"></div>
            <div class="input-group full-width"><label>æ¥æ”¶ Email (å¿…å¡«)</label><input type="email" id="cupperEmail" placeholder="name@company.com"></div>
        </div>

        <div class="section-title">ğŸ§ª æ¨£å“å®šç¾© & å¿«é€Ÿæ¯”è¼ƒ</div>
        <div class="sample-names">
            <div style="font-size:12px; color:#888; text-align:right; padding-top:10px;">æ¨£å“åç¨± â¤</div>
            <div class="sample-col"><input type="text" id="nameA" value="æ¨£å“ A" oninput="updateChart()" placeholder="Sample A"></div>
            <div class="sample-col"><input type="text" id="nameB" value="æ¨£å“ B" oninput="updateChart()" placeholder="Sample B"></div>
            <div class="sample-col"><input type="text" id="nameC" value="æ¨£å“ C" oninput="updateChart()" placeholder="Sample C"></div>
        </div>

        <div id="scoreArea">
            </div>

        <div class="section-title">ğŸ“ ç¶œåˆç­†è¨˜</div>
        <textarea id="notes" rows="3" placeholder="é‡å°é€™ä¸‰æ¬¾èŒ¶çš„ç¶œåˆé¢¨å‘³æ¯”è¼ƒæˆ–å·®ç•°æè¿°..."></textarea>
    </div>

    <div class="preview">
        <div class="chart-container"><canvas id="radarChart"></canvas></div>
        <button class="btn-submit" id="submitBtn" onclick="processData()">ğŸš€ æ¥µé€Ÿä¸Šå‚³ä¸¦å¯„é€å ±å‘Š</button>
        <p style="font-size:12px; color:#aaa; margin-top:10px;">*ç³»çµ±å°‡è‡ªå‹•ç”Ÿæˆä¸‰æ¨£å“æ¯”è¼ƒåœ–èˆ‡æ•¸æ“šè¡¨</p>
    </div>
</div>

<script>
    // ================= CONFIG =================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwe4QryJQ0Gcf6guVEXs1a3Z_tM3la_oq-queI09S0Qd8zql3o6L87XF3-sh705AHNymg/exec";
    // ==========================================

    const attributes = [
        { en: "Acidity", ch: "æ˜äº®é®®çˆ½", key: "p1" },
        { en: "Sweetness", ch: "å›ç”˜èœœéŸ»", key: "p2" },
        { en: "Body", ch: "èŒ¶æ¹¯ç¨ åº¦", key: "p3" },
        { en: "Aroma", ch: "å±¤æ¬¡èª¿æ€§", key: "p4" },
        { en: "Balance", ch: "å”èª¿æ€§", key: "p5" },
        { en: "Structure", ch: "æ”¶æ–‚è½‰åŒ–", key: "p6" }
    ];

    let myChart;

    // åˆå§‹åŒ–ï¼šç”Ÿæˆ HTML èˆ‡ åœ–è¡¨
    window.onload = function() {
        generateScoreInputs();
        initChart();
    };

    function generateScoreInputs() {
        const area = document.getElementById('scoreArea');
        let html = '';
        attributes.forEach((attr, idx) => {
            html += `
            <div class="score-grid">
                <div class="score-label">${attr.en}<span class="term-sub">${attr.ch}</span></div>
                <div class="range-wrap sample-a">
                    <span class="range-val color-a" id="vA${idx}">4.0</span>
                    <input type="range" id="A_p${idx}" min="0" max="5" step="0.1" value="4.0" oninput="updateVal('A', ${idx})">
                </div>
                <div class="range-wrap sample-b">
                    <span class="range-val color-b" id="vB${idx}">3.0</span>
                    <input type="range" id="B_p${idx}" min="0" max="5" step="0.1" value="3.0" oninput="updateVal('B', ${idx})">
                </div>
                <div class="range-wrap sample-c">
                    <span class="range-val color-c" id="vC${idx}">2.0</span>
                    <input type="range" id="C_p${idx}" min="0" max="5" step="0.1" value="2.0" oninput="updateVal('C', ${idx})">
                </div>
            </div>`;
        });
        area.innerHTML = html;
    }

    function updateVal(sample, idx) {
        document.getElementById(`v${sample}${idx}`).innerText = document.getElementById(`${sample}_p${idx}`).value;
        updateChart();
    }

    function initChart() {
        const ctx = document.getElementById('radarChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: attributes.map(a => [a.en, a.ch]),
                datasets: [
                    { label: 'Sample A', data: [4,4,4,4,4,4], borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', borderWidth: 2 },
                    { label: 'Sample B', data: [3,3,3,3,3,3], borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', borderWidth: 2 },
                    { label: 'Sample C', data: [2,2,2,2,2,2], borderColor: '#27ae60', backgroundColor: 'rgba(39, 174, 96, 0.1)', borderWidth: 2 }
                ]
            },
            options: {
                responsive: true,
                scales: { r: { suggestedMin: 0, suggestedMax: 5, pointLabels: { font: { size: 12, weight:'bold'} } } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function updateChart() {
        const dataA = attributes.map((_, i) => document.getElementById(`A_p${i}`).value);
        const dataB = attributes.map((_, i) => document.getElementById(`B_p${i}`).value);
        const dataC = attributes.map((_, i) => document.getElementById(`C_p${i}`).value);
        
        myChart.data.datasets[0].label = document.getElementById('nameA').value || 'A';
        myChart.data.datasets[0].data = dataA;
        
        myChart.data.datasets[1].label = document.getElementById('nameB').value || 'B';
        myChart.data.datasets[1].data = dataB;

        myChart.data.datasets[2].label = document.getElementById('nameC').value || 'C';
        myChart.data.datasets[2].data = dataC;

        myChart.update();
    }

    function autoFillStyle() {
        // å¯æ ¹æ“šèŒ¶ç¨®è®Šæ›´èƒŒæ™¯è‰²æˆ–é è¨­å€¼ (æ­¤è™•ç‚ºæ“´å……é ç•™)
        console.log("Category changed: " + document.getElementById('teaCategory').value);
    }

    // --- åœ–ç‰‡ç”Ÿæˆ (å«è¡¨æ ¼æ•¸æ“š) ---
    function generateLayoutImage(callback) {
        const canvas = document.getElementById('radarChart');
        const tempCanvas = document.createElement('canvas');
        const ctx = tempCanvas.getContext('2d');
        
        // è¨­å®šç•«å¸ƒå°ºå¯¸ (å¢åŠ ä¸‹æ–¹æ•¸æ“šè¡¨ç©ºé–“)
        const scale = 2;
        const extraH = 400; 
        tempCanvas.width = canvas.width * scale;
        tempCanvas.height = (canvas.height * scale) + extraH;
        
        // ç™½è‰²èƒŒæ™¯
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,tempCanvas.width, tempCanvas.height);
        
        // ç¹ªè£½åœ–è¡¨
        ctx.save(); ctx.scale(scale, scale); ctx.drawImage(canvas, 0, 0); ctx.restore();

        // ç¹ªè£½æ¨™é¡Œèˆ‡è³‡è¨Š
        let y = (canvas.height * scale) + 20;
        const cw = tempCanvas.width;
        
        ctx.font = "bold 30px Microsoft JhengHei"; ctx.textAlign = "center"; ctx.fillStyle = "#333";
        ctx.fillText(`SCA x TAGs è©•é‘‘æ¯”è¼ƒ (${document.getElementById('teaCategory').value})`, cw/2, 50);

        ctx.font = "24px Microsoft JhengHei"; ctx.fillStyle = "#666";
        const meta = `Cupper: ${document.getElementById('cupperName').value} | Ratio: ${document.getElementById('brewRatio').value} | Time: ${document.getElementById('brewTime').value}`;
        ctx.fillText(meta, cw/2, y); y += 50;

        // ç¹ªè£½ç°¡æ˜“æ•¸æ“šè¡¨
        const colW = cw / 4;
        const headers = ["Attribute", document.getElementById('nameA').value, document.getElementById('nameB').value, document.getElementById('nameC').value];
        
        // è¡¨é ­
        ctx.fillStyle = "#eee"; ctx.fillRect(50, y-30, cw-100, 40);
        ctx.fillStyle = "#000"; ctx.font = "bold 22px Microsoft JhengHei";
        headers.forEach((h, i) => ctx.fillText(h, 50 + colW*i + colW/2, y)); 
        y += 40;

        // å…§å®¹
        ctx.font = "20px Microsoft JhengHei";
        attributes.forEach((attr, idx) => {
            const valA = document.getElementById(`A_p${idx}`).value;
            const valB = document.getElementById(`B_p${idx}`).value;
            const valC = document.getElementById(`C_p${idx}`).value;
            
            ctx.fillStyle = "#444"; ctx.textAlign="center";
            ctx.fillText(attr.en, 50 + colW/2, y);
            
            ctx.fillStyle = "#e74c3c"; ctx.fillText(valA, 50 + colW*1.5, y);
            ctx.fillStyle = "#3498db"; ctx.fillText(valB, 50 + colW*2.5, y);
            ctx.fillStyle = "#27ae60"; ctx.fillText(valC, 50 + colW*3.5, y);
            
            // ç•«åº•ç·š
            ctx.strokeStyle="#eee"; ctx.beginPath(); ctx.moveTo(50, y+10); ctx.lineTo(cw-50, y+10); ctx.stroke();
            y += 40;
        });

        // è¼¸å‡º JPEG (0.7 å“è³ªå£“ç¸® = åŠ é€Ÿé—œéµ)
        callback(tempCanvas.toDataURL('image/jpeg', 0.7));
    }

    function processData() {
        const btn = document.getElementById('submitBtn');
        const email = document.getElementById('cupperEmail').value;
        if(!email.includes("@")) { alert("è«‹å¡«å¯«æ­£ç¢º Email"); return; }
        
        btn.disabled = true; btn.innerText = "â³ å£“ç¸®åœ–ç‰‡ä¸¦ä¸Šå‚³ä¸­...";

        generateLayoutImage((base64) => {
            // æ§‹å»ºä¸‰ç­†è³‡æ–™ (æˆ–ä¸€ç­†åˆä½µè³‡æ–™ï¼Œè¦–æ‚¨ Sheet é‚è¼¯ï¼Œé€™è£¡æ¡ç”¨å–®ç­†å¯¬è¡¨ä»¥ç¬¦åˆæ—¢æœ‰çµæ§‹)
            const payload = {
                cupper: document.getElementById('cupperName').value,
                email: email,
                category: document.getElementById('teaCategory').value,
                ratio: document.getElementById('brewRatio').value,
                time: document.getElementById('brewTime').value,
                // A æ¨£å“
                teaA: document.getElementById('nameA').value,
                scoresA: attributes.map((_, i) => document.getElementById(`A_p${i}`).value),
                // B æ¨£å“
                teaB: document.getElementById('nameB').value,
                scoresB: attributes.map((_, i) => document.getElementById(`B_p${i}`).value),
                // C æ¨£å“
                teaC: document.getElementById('nameC').value,
                scoresC: attributes.map((_, i) => document.getElementById(`C_p${i}`).value),
                note: document.getElementById('notes').value,
                image: base64 // é€™æ˜¯ JPEG 
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼åœ–ç‰‡å·²å¯„å‡ºã€‚");
                btn.disabled = false; btn.innerText = "ğŸš€ æ¥µé€Ÿä¸Šå‚³ä¸¦å¯„é€å ±å‘Š";
            }).catch(e => {
                alert("âŒ éŒ¯èª¤ï¼š" + e);
                btn.disabled = false;
            });
        });
    }
</script>

</body>
</html>
