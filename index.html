<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCA x TAGs è©•é‘‘ (Cloud Sync Ver.)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ä¿æŒåŸæœ¬çš„å„ªé›…è¨­è¨ˆ */
        body { font-family: "Microsoft JhengHei", sans-serif; background: #ece9e6; display: flex; justify-content: center; padding: 20px; min-height: 100vh; color: #2c3e50; }
        .container { background: white; width: 100%; max-width: 1200px; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; overflow: hidden; margin-bottom: 50px; }
        .controls { flex: 1; min-width: 350px; padding: 40px; background: #f8f9fa; border-right: 1px solid #e0e0e0; height: 85vh; overflow-y: auto; }
        .header { margin-bottom: 25px; border-bottom: 3px solid #6f4e37; padding-bottom: 15px; }
        h2 { margin: 0; color: #6f4e37; font-size: 24px; font-weight: 800; }
        .badge { background: #27ae60; color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .section-title { font-size: 14px; color: #888; margin: 20px 0 10px 0; border-left: 3px solid #27ae60; padding-left: 8px; font-weight: bold; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #34495e; font-size: 14px; }
        input[type="text"], input[type="email"], textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
        input[type="color"] { width: 100%; height: 45px; border: none; padding: 0; cursor: pointer; }
        .hybrid-slider { margin-bottom: 25px; background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: 0.3s; }
        .hybrid-slider:hover { border-left-color: #6f4e37; transform: translateX(5px); }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .term-coffee { font-size: 16px; font-weight: 900; color: #6f4e37; } .term-tea { font-size: 14px; color: #27ae60; font-weight: bold; } .term-desc { font-size: 12px; color: #7f8c8d; margin-bottom: 10px; display: block; }
        input[type="range"] { width: 100%; accent-color: #6f4e37; cursor: pointer; }
        .val-display { font-weight: bold; color: #6f4e37; font-size: 18px; }
        .preview { flex: 1.4; min-width: 400px; padding: 40px; display: flex; flex-direction: column; align-items: center; background: #fff; }
        .btn-submit { margin-top: 20px; background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; border: none; padding: 15px 40px; font-size: 16px; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4); }
        @media (max-width: 768px) { .container { flex-direction: column; } .controls { border-right: none; height: auto; } }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <div class="header">
            <h2>SCA x TAGs è©•é‘‘ <span class="badge">Google Sync</span></h2>
        </div>
        
        <div class="section-title">ğŸ‘¤ è©•é‘‘è€…è³‡è¨Š</div>
        <div class="input-group"><label>å§“å</label><input type="text" id="cupperName" placeholder="æ‚¨çš„ç¨±å‘¼"></div>
        <div class="input-group"><label>Email</label><input type="email" id="cupperEmail" placeholder="ç”¨æ–¼å»ºæª”"></div>

        <div class="section-title">ğŸµ èŒ¶å“è¨­å®š</div>
        <div class="input-group"><label>å“é …åç¨±</label><input type="text" id="teaName" value="2025 èœœé¦™ç´…èŒ¶ãƒ»æ‰‹æ²–" oninput="updateChart()"></div>
        <div class="input-group"><label>ä»£è¡¨è‰²</label><input type="color" id="themeColor" value="#A0522D" oninput="updateChart()"></div>
        <div class="input-group"><label>æ¯æ¸¬ç­†è¨˜</label><textarea id="teaDesc" rows="3" placeholder="é¢¨å‘³æ•˜è¿°..." oninput="updateChart()"></textarea></div>

        <div class="section-title">ğŸ“Š é¢¨å‘³è©•åˆ†</div>
        <div class="hybrid-slider"><div class="slider-header"><div><span class="term-coffee">Acidity</span> / <span class="term-tea">æ˜äº®é®®çˆ½</span></div><span class="val-display" id="v1">4.0</span></div><input type="range" id="p1" min="0" max="5" step="0.1" value="4.0" oninput="updateChart()"></div>
        <div class="hybrid-slider"><div class="slider-header"><div><span class="term-coffee">Sweetness</span> / <span class="term-tea">å›ç”˜èœœéŸ»</span></div><span class="val-display" id="v2">4.5</span></div><input type="range" id="p2" min="0" max="5" step="0.1" value="4.5" oninput="updateChart()"></div>
        <div class="hybrid-slider"><div class="slider-header"><div><span class="term-coffee">Body</span> / <span class="term-tea">èŒ¶æ¹¯ç¨ åº¦</span></div><span class="val-display" id="v3">4.2</span></div><input type="range" id="p3" min="0" max="5" step="0.1" value="4.2" oninput="updateChart()"></div>
        <div class="hybrid-slider"><div class="slider-header"><div><span class="term-coffee">Aroma</span> / <span class="term-tea">å±¤æ¬¡èª¿æ€§</span></div><span class="val-display" id="v4">4.8</span></div><input type="range" id="p4" min="0" max="5" step="0.1" value="4.8" oninput="updateChart()"></div>
        <div class="hybrid-slider"><div class="slider-header"><div><span class="term-coffee">Balance</span> / <span class="term-tea">å”èª¿æ€§</span></div><span class="val-display" id="v5">4.3</span></div><input type="range" id="p5" min="0" max="5" step="0.1" value="4.3" oninput="updateChart()"></div>
        <div class="hybrid-slider"><div class="slider-header"><div><span class="term-coffee">Structure</span> / <span class="term-tea">æ”¶æ–‚è½‰åŒ–</span></div><span class="val-display" id="v6">3.8</span></div><input type="range" id="p6" min="0" max="5" step="0.1" value="3.8" oninput="updateChart()"></div>
    </div>

    <div class="preview">
        <div style="width:100%; max-width:550px; position:relative;"><canvas id="radarChart"></canvas></div>
        <button class="btn-submit" id="submitBtn" onclick="saveToGoogleSheet()">
            â˜ï¸ ä¸Šå‚³ Google Sheet ä¸¦ä¸‹è¼‰åœ–å¡
        </button>
        <p style="font-size:12px; color:#888; margin-top:10px;">*æ•¸æ“šå°‡å³æ™‚åŒæ­¥è‡³æ‚¨çš„é›²ç«¯è©¦ç®—è¡¨</p>
    </div>
</div>

<script>
    // ==========================================
    // âœ… å·²æ¤å…¥æ‚¨çš„ Google Apps Script ç¶²å€
    // ==========================================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxAtDRydSip_hLcP17lI5wLRkU7hSzxNkJvdRTPUbst72OUVadxxQtWJKyvI_Ho9Mk/exec";
    // ==========================================

    let myChart;
    const labels = [['Acidity','æ˜äº®é®®çˆ½'],['Sweetness','å›ç”˜èœœéŸ»'],['Body','èŒ¶æ¹¯ç¨ åº¦'],['Aroma','å±¤æ¬¡èª¿æ€§'],['Balance','å”èª¿æ€§'],['Structure','æ”¶æ–‚è½‰åŒ–']];
    const legendData = [
        {coffee:"Acidity",tea:"æ˜äº®é®®çˆ½",desc:"æœé…¸éŸ»èˆ‡èŒ¶æ¹¯æ´»æ€§"}, {coffee:"Sweetness",tea:"å›ç”˜èœœéŸ»",desc:"é£²å¾Œç”Ÿæ´¥èˆ‡å–‰éŸ»"}, {coffee:"Body",tea:"èŒ¶æ¹¯ç¨ åº¦",desc:"æ¶²é«”é‡é‡èˆ‡é£½æ»¿æ„Ÿ"},
        {coffee:"Aroma",tea:"å±¤æ¬¡èª¿æ€§",desc:"ä¹¾æ¿•é¦™èˆ‡å‰ä¸­å¾Œèª¿"}, {coffee:"Balance",tea:"å”èª¿æ€§",desc:"é¢¨å‘³èåˆç„¡ç¼ºé™·"}, {coffee:"Structure",tea:"æ”¶æ–‚è½‰åŒ–",desc:"å–®å¯§æ„Ÿèˆ‡ç«‹é«”éª¨æ¶"}
    ];

    function initChart() {
        const ctx = document.getElementById('radarChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{ label: 'Score', data: [4.0, 4.5, 4.2, 4.8, 4.3, 3.8], fill: true, backgroundColor: 'rgba(160, 82, 45, 0.2)', borderColor: '#A0522D', pointBackgroundColor: '#A0522D', pointBorderColor: '#fff', borderWidth: 3, pointRadius: 5 }]
            },
            options: { responsive: true, scales: { r: { angleLines: { color: '#e0e0e0' }, grid: { color: '#f0f0f0' }, suggestedMin: 0, suggestedMax: 5, ticks: { display: false, stepSize: 1 }, pointLabels: { font: { size: 14, family: "Microsoft JhengHei", weight: 'bold' }, color: '#555' } } }, plugins: { legend: { display: false }, title: { display: true, text: '2025 èœœé¦™ç´…èŒ¶ãƒ»æ‰‹æ²–', font: { size: 24, weight: 'bold' }, padding: { bottom: 20 }, color: '#6f4e37' } } }
        });
    }

    function updateChart() {
        const name = document.getElementById('teaName').value;
        const color = document.getElementById('themeColor').value;
        const data = [1,2,3,4,5,6].map(i => document.getElementById('p'+i).value);
        data.forEach((v, i) => document.getElementById('v'+(i+1)).innerText = v);
        myChart.data.datasets[0].data = data;
        myChart.data.datasets[0].borderColor = color;
        myChart.data.datasets[0].pointBackgroundColor = color;
        const r = parseInt(color.slice(1, 3), 16), g = parseInt(color.slice(3, 5), 16), b = parseInt(color.slice(5, 7), 16);
        myChart.data.datasets[0].backgroundColor = `rgba(${r}, ${g}, ${b}, 0.25)`;
        myChart.options.plugins.title.text = name;
        myChart.update();
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        if(!text) return y;
        const paragraphs = text.split('\n');
        for (let p = 0; p < paragraphs.length; p++) {
            let words = paragraphs[p].split(''); let line = '';
            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n];
                if (ctx.measureText(testLine).width > maxWidth && n > 0) { ctx.fillText(line, x, y); line = words[n]; y += lineHeight; } else { line = testLine; }
            }
            ctx.fillText(line, x, y); y += lineHeight;
        }
        return y;
    }

    function downloadImage() {
        const canvas = document.getElementById('radarChart');
        const name = document.getElementById('teaName').value;
        const desc = document.getElementById('teaDesc').value;
        const cupper = document.getElementById('cupperName').value;
        const tempCanvas = document.createElement('canvas');
        const ctx = tempCanvas.getContext('2d');
        const scale = 2; 
        let extraHeight = 340; if(desc) extraHeight += 150;
        tempCanvas.width = canvas.width * scale; tempCanvas.height = (canvas.height * scale) + extraHeight;
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        ctx.save(); ctx.scale(scale, scale); ctx.drawImage(canvas, 0, 0); ctx.restore();
        let currentY = (canvas.height * scale) + 40;
        if (desc) {
            ctx.textAlign = "center"; ctx.font = `bold 32px "Microsoft JhengHei"`; ctx.fillStyle = "#6f4e37"; ctx.fillText("ğŸ“ Cupping Notes", tempCanvas.width / 2, currentY); currentY += 50;
            ctx.font = `26px "Microsoft JhengHei"`; ctx.fillStyle = "#444"; currentY = wrapText(ctx, desc, tempCanvas.width / 2, currentY, tempCanvas.width * 0.85, 40); currentY += 60;
        }
        if(cupper) { ctx.textAlign = "right"; ctx.font = `italic 24px "Microsoft JhengHei"`; ctx.fillStyle = "#aaa"; ctx.fillText(`Cupper: ${cupper} / ${new Date().toLocaleDateString()}`, tempCanvas.width - 50, 50); }
        ctx.textAlign = "center"; ctx.font = `bold 24px "Microsoft JhengHei"`; ctx.fillStyle = "#888"; ctx.fillText("â”€â”€ SCA (Coffee) â‡„ TAGs (Tea) â”€â”€", tempCanvas.width/2, currentY); currentY += 40;
        ctx.textAlign = "left"; const startX = 100; const col2X = tempCanvas.width / 2 + 60;
        for(let i=0; i<3; i++) {
            ctx.font = `bold 22px "Microsoft JhengHei"`; ctx.fillStyle = "#6f4e37"; ctx.fillText(`${legendData[i].coffee} â‡„ ${legendData[i].tea}`, startX, currentY + (i*60));
            ctx.font = `18px "Microsoft JhengHei"`; ctx.fillStyle = "#666"; ctx.fillText(legendData[i].desc, startX, currentY + (i*60) + 25);
        }
        for(let i=3; i<6; i++) {
            ctx.font = `bold 22px "Microsoft JhengHei"`; ctx.fillStyle = "#6f4e37"; ctx.fillText(`${legendData[i].coffee} â‡„ ${legendData[i].tea}`, col2X, currentY + ((i-3)*60));
            ctx.font = `18px "Microsoft JhengHei"`; ctx.fillStyle = "#666"; ctx.fillText(legendData[i].desc, col2X, currentY + ((i-3)*60) + 25);
        }
        const link = document.createElement('a'); link.download = `${name}_è©•é‘‘å¡.png`; link.href = tempCanvas.toDataURL('image/png'); link.click();
    }

    // --- æ ¸å¿ƒï¼šå‚³é€è³‡æ–™åˆ° Google Sheets ---
    function saveToGoogleSheet() {
        const btn = document.getElementById('submitBtn');

        // 1. é–å®šæŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
        btn.disabled = true;
        btn.innerText = "â˜ï¸ ä¸Šå‚³ä¸­...";

        const data = {
            cupper: document.getElementById('cupperName').value || 'Anonymous',
            email: document.getElementById('cupperEmail').value || '-',
            tea: document.getElementById('teaName').value,
            scores: [1,2,3,4,5,6].map(i => document.getElementById('p'+i).value),
            note: document.getElementById('teaDesc').value || ''
        };

        // 2. ç™¼é€è³‡æ–™ (è·¨åŸŸ POST)
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors", // é‡è¦ï¼šGoogle Apps Script ç°¡æ˜“è«‹æ±‚éœ€è¦æ­¤æ¨¡å¼
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
        .then(() => {
            alert("âœ… è³‡æ–™å·²æˆåŠŸä¸Šå‚³è‡³ Google Sheetï¼\n(åœ–ç‰‡å°‡æ¥è‘—ä¸‹è¼‰)");
            downloadImage(); // ä¸Šå‚³æˆåŠŸå¾Œï¼Œè‡ªå‹•ä¸‹è¼‰åœ–ç‰‡
            btn.disabled = false;
            btn.innerText = "â˜ï¸ ä¸Šå‚³ Google Sheet ä¸¦ä¸‹è¼‰åœ–å¡";
        })
        .catch(error => {
            console.error('Error:', error);
            alert("âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Script è¨­å®š");
            btn.disabled = false;
            btn.innerText = "â˜ï¸ ä¸Šå‚³ Google Sheet ä¸¦ä¸‹è¼‰åœ–å¡";
        });
    }

    window.onload = initChart;
</script>

</body>
</html>
